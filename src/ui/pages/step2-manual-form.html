<div class="fr-mb-4w">
  <h3>Renseignez des données complémentaires</h3>
  <p class="fr-text--sm">Complétez les champs suivants pour améliorer la fiabilité des résultats qui vont suivre</p>

  <form id="manual-form">

    <!-- Infos du site -->
    <h5>Informations du site</h5>

    <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w">

      <!-- Type de propriétaire -->
      <div class="fr-col-12 fr-col-md-6">
        <div class="fr-select-group">
          <label class="fr-label" for="type-proprietaire">
            Type de propriétaire <span class="fr-text--red">*</span>
          </label>
          <select class="fr-select" id="type-proprietaire" name="typeProprietaire" required>
            <option value="" selected>Sélectionner une option</option>
            <option value="public">Public</option>
            <option value="prive">Privé</option>
            <option value="mixte">Mixte public et privé</option>
            <option value="copro-indivision">Copropriété / Indivision</option>
            <option value="ne-sait-pas">Ne sait pas</option>
          </select>
          <div class="fr-error-text" id="type-proprietaire-error" style="display: none;">
            Obligatoire
          </div>
        </div>
      </div>

      <!-- Réseaux d'eaux -->
      <div class="fr-col-12 fr-col-md-6">
        <div class="fr-select-group">
          <label class="fr-label" for="reseau-eaux">
            Site connecté aux réseaux d'eaux <span class="fr-text--red">*</span>
          </label>
          <select class="fr-select" id="reseau-eaux" name="reseauEaux" required>
            <option value="" selected>Sélectionner une option</option>
            <option value="oui">Oui</option>
            <option value="non">Non</option>
            <option value="ne-sait-pas">Ne sait pas</option>
          </select>
          <div class="fr-error-text" id="reseau-eaux-error" style="display: none;">
            Obligatoire
          </div>
        </div>
      </div>

      <!-- Etat construction -->
      <div class="fr-col-12 fr-col-md-6">
        <div class="fr-select-group">
          <label class="fr-label" for="etat-bati">
            État des constructions <span class="fr-text--red">*</span>
          </label>
          <select class="fr-select" id="etat-bati" name="etatBati" required>
            <option value="" selected>Sélectionner une option</option>
            <option value="pas-de-bati">Pas de bâti</option>
            <option value="en-ruine-dangereux">En ruine / dangereux</option>
            <option value="forte-degradation">Forte dégradation</option>
            <option value="etat-moyen">État moyen</option>
            <option value="bon-etat-apparent">Bon état apparent</option>
            <option value="etat-remarquable">État remarquable</option>
            <option value="batiments-heterogenes">Bâtiments hétérogènes</option>
            <option value="ne-sait-pas">Ne sait pas</option>
          </select>
          <div class="fr-error-text" id="etat-bati-error" style="display: none;">
            Obligatoire
          </div>
        </div>
      </div>

      <!--  Pollution -->
      <div class="fr-col-12 fr-col-md-6">
        <div class="fr-select-group">
          <label class="fr-label" for="presence-pollution">
            Présence de pollution <span class="fr-text--red">*</span>
          </label>
          <select class="fr-select" id="presence-pollution" name="presencePollution" required>
            <option value="" selected>Sélectionner une option</option>
            <option value="non">Non</option>
            <option value="deja-geree">Déjà gérée</option>
            <option value="oui-composes-volatils">Oui - composés volatils</option>
            <option value="oui-autres-composes">Oui - autres composés</option>
            <option value="ne-sait-pas">Ne sait pas</option>
          </select>
          <div class="fr-error-text" id="presence-pollution-error" style="display: none;">
            Obligatoire
          </div>
        </div>
      </div>

      <!--  Intérêt architectural -->
      <div class="fr-col-12 fr-col-md-6">
        <div class="fr-select-group">
          <label class="fr-label" for="valeur-architecturale">
            Intérêt architectural et historique des constructions <span class="fr-text--red">*</span>
          </label>
          <select class="fr-select" id="valeur-architecturale" name="valeurArchitecturale" required>
            <option value="" selected>Sélectionner une option</option>
            <option value="sans-interet">Sans intérêt</option>
            <option value="banal-infra-ordinaire">Banal / infra-ordinaire</option>
            <option value="ordinaire">Ordinaire</option>
            <option value="interet-fort">Intérêt fort</option>
            <option value="exceptionnel">Exceptionnel</option>
            <option value="ne-sait-pas">Ne sait pas</option>
          </select>
          <div class="fr-error-text" id="valeur-architecturale-error" style="display: none;">
            Obligatoire
          </div>
        </div>
      </div>
    </div>

    <hr />

    <!-- Environnement du site -->
    <h5>Environnement du site</h5>

    <div class="fr-grid-row fr-grid-row--gutters">

      <div class="fr-col-12 fr-col-md-6">
        <div class="fr-select-group">
          <label class="fr-label" for="qualite-paysagere">
            Intérêt du paysage environnant <span class="fr-text--red">*</span>
          </label>
          <select class="fr-select" id="qualite-paysagere" name="qualitePaysagere" required>
            <option value="" selected>Sélectionner une option</option>
            <option value="degrade">Dégradé</option>
            <option value="banal-infra-ordinaire">Banal / infra-ordinaire</option>
            <option value="quotidien-ordinaire">Quotidien / ordinaire</option>
            <option value="interessant">Intéressant</option>
            <option value="remarquable">Remarquable</option>
            <option value="ne-sait-pas">Ne sait pas</option>
          </select>
          <div class="fr-error-text" id="qualite-paysagere-error" style="display: none;">
            Obligatoire
          </div>
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-6">
        <div class="fr-select-group">
          <label class="fr-label" for="qualite-desserte">
            Accessibilité par les voies de circulation <span class="fr-text--red">*</span>
          </label>
          <select class="fr-select" id="qualite-desserte" name="qualiteDesserte" required>
            <option value="" selected>Sélectionner une option</option>
            <option value="accessible">Accessible</option>
            <option value="degradee">Dégradée</option>
            <option value="peu-accessible">Peu accessible</option>
            <option value="ne-sait-pas">Ne sait pas</option>
          </select>
          <div class="fr-error-text" id="qualite-desserte-error" style="display: none;">
            Obligatoire
          </div>
        </div>
      </div>
    </div>

  </form>

</div>

<div class="fr-mt-4w" style="text-align: center;">
  <a href="{{previousUrl}}" class="fr-btn fr-btn--secondary">
    <span class="fr-icon-arrow-left-s-line fr-icon--sm" aria-hidden="true"></span>
    Précédent
  </a>
  <button class="fr-btn fr-ml-2w" onclick="submitAndGoToResult()" id="submit-btn">
    Calculer les résultats
    <span class="fr-icon-arrow-right-s-line fr-icon--sm" aria-hidden="true"></span>
  </button>
</div>

<script>
  function submitAndGoToResult() {
    const form = document.getElementById('manual-form');
    const formData = new FormData(form);

    // Liste des champs obligatoires
    const requiredFields = [
      'type-proprietaire',
      'reseau-eaux',
      'etat-bati',
      'presence-pollution',
      'valeur-architecturale',
      'qualite-paysagere',
      'qualite-desserte'
    ];

    let isValid = true;

    // Validation de chaque champ
    requiredFields.forEach(fieldId => {
      const element = document.getElementById(fieldId);
      const errorElement = document.getElementById(fieldId + '-error');

      if (!element.value || element.value === '') {
        // Afficher l'erreur
        element.classList.add('fr-select--error');
        errorElement.style.display = 'block';
        isValid = false;
      } else {
        // Masquer l'erreur
        element.classList.remove('fr-select--error');
        errorElement.style.display = 'none';
      }
    });

    if (!isValid) {
      // Faire défiler vers le premier champ en erreur
      const firstError = document.querySelector('.fr-select--error');
      if (firstError) {
        firstError.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }
      return;
    }

    // Désactiver le bouton
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Sauvegarde en cours...';

    // Convertir FormData en objet JSON
    const data = {};
    for (let [key, value] of formData.entries()) {
      // Mapper les noms d'attributs HTML vers les noms attendus par l'API
      const apiFieldName = key.replace(/-/g, ''); // Supprimer les tirets

      // Mapping spécifique si nécessaire
      switch (key) {
        case 'type-proprietaire':
          data.typeProprietaire = value;
          break;
        case 'reseau-eaux':
          data.reseauEaux = value;
          break;
        case 'etat-bati':
          data.etatBati = value;
          break;
        case 'presence-pollution':
          data.presencePollution = value;
          break;
        case 'valeur-architecturale':
          data.valeurArchitecturale = value;
          break;
        case 'qualite-paysagere':
          data.qualitePaysagere = value;
          break;
        case 'qualite-desserte':
          data.qualiteDesserte = value;
          break;
        default:
          data[apiFieldName] = value;
      }
    }

    console.log('Données à envoyer:', data);

    // Appel à l'API pour sauvegarder
    fetch('/analyse/sauvegarder-donnees', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include', // Important pour les cookies de session
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(result => {
        console.log('Réponse API:', result);

        if (result.success) {
          // Redirection vers l'étape suivante
          window.location.href = '/analyse/resultats';
        } else {
          // Afficher l'erreur
          alert('Erreur lors de la sauvegarde: ' + (result.message || 'Erreur inconnue'));

          // Réactiver le bouton
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Calculer les résultats <span class="fr-icon-arrow-right-s-line fr-icon--sm" aria-hidden="true"></span>';
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur de communication avec le serveur');

        // Réactiver le bouton
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Calculer les résultats <span class="fr-icon-arrow-right-s-line fr-icon--sm" aria-hidden="true"></span>';
      });
  }
</script>