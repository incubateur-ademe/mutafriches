<style>
  .collapsed {
    height: 0;
    overflow: hidden;
    opacity: 0;
    transition: height 0.3s ease, opacity 0.3s ease;
  }

  .collapsed.expanded {
    height: auto;
    opacity: 1;
  }

  .input-mode {
    display: none;
  }

  .input-mode.active {
    display: block;
  }
</style>

<div class="fr-mb-4w">
  <h3>S√©lectionnez la (les) parcelle(s) concern√©e(s)</h3>

  <!-- Choix parcelle.s -->
  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-md-8">
      <!-- Contr√¥le segment√© pour choisir le mode -->
      <fieldset class="fr-segmented fr-mb-4w">
        <div class="fr-segmented__elements">
          <div class="fr-segmented__element">
            <input value="id" type="radio" id="mode-id" name="selection-mode" checked onchange="switchMode('id')">
            <label class="fr-icon-edit-line fr-label" for="mode-id">
              Par identifiant de parcelle
            </label>
          </div>
          <div class="fr-segmented__element">
            <input value="carte" type="radio" id="mode-carte" name="selection-mode" onchange="switchMode('carte')">
            <label class="fr-icon-map-pin-2-line fr-label" for="mode-carte">
              Depuis la carte
            </label>
          </div>
        </div>
      </fieldset>
    </div>

    <div class="fr-col-12 fr-col-md-4">
      <!-- Choix simple ou multi parcelle -->
      <fieldset class="fr-segmented fr-segmented--sm fr-mb-4w">
        <div class="fr-segmented__elements">
          <div class="fr-segmented__element">
            <input value="1" checked type="radio" id="multiparcelle-map-simple" name="multiparcelle-map"
              onchange="handleMultiParcelleChange(event)">
            <label class="fr-icon-home-4-fill fr-label" for="multiparcelle-map-simple">Une parcelle</label>
          </div>
          <div class="fr-segmented__element">
            <input value="2" type="radio" id="multiparcelle-map-multi" name="multiparcelle-map"
              onchange="handleMultiParcelleChange(event)">
            <label class="fr-icon-community-fill fr-label" for="multiparcelle-map-multi">Plusieurs parcelles</label>
          </div>
        </div>
      </fieldset>
    </div>
  </div>

  <!-- Mode carte -->
  <div id="carte-mode" class="input-mode ">
    <p class="fr-text--sm">Cliquez sur la carte pour s√©lectionner la (les) parcelle(s) √† analyser</p>
    <div class="fr-grid-row fr-grid-row--gutters">
      <div id="map-col" class="fr-col-12">
        <!-- Carte fictive -->
        <div id="map-container"
          style="height: 400px; background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border: 2px solid #18753c; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;"
          onclick="selectParcel()">
          <div style="text-align: center; color: #18753c;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
            <p style="margin: 0; font-weight: bold;">Carte interactive</p>
            <p style="margin: 0; font-size: 0.9rem;">Cliquez pour s√©lectionner la parcelle "Ancienne manufacture Les
              Allumettes"</p>
          </div>

          <!-- Point de parcelle fictif -->
          <div id="parcel-point"
            style="position: absolute; top: 60%; left: 45%; width: 20px; height: 20px; background: #000091; border: 3px solid white; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"
            onclick="selectParcel(event)"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mode saisie Identifiant Parcelle -->
  <div id="id-mode" class="input-mode active">
    <p class="fr-text--sm">Saisissez l'identifiant ou les identifiants des parcelles √† analyser</p>
    <div class="fr-grid-row fr-grid-row--gutters">
      <!-- Message d'info pour l'ID -->
      <div class="fr-callout fr-callout--green-emeraude fr-mt-2w">
        <p class="fr-callout__text">
          L'Identifiant de parcelle peut √™tre trouv√© sur le cadastre ou les documents officiels de la propri√©t√©.
        </p>
        <a href="https://www.cadastre.gouv.fr" target="_blank" rel="noopener noreferrer"
          class="fr-btn fr-btn--secondary fr-btn--icon-left">
          Consulter le cadastre
        </a>
      </div>

      <div class="fr-col-12 fr-col-md-6">
        <div class="fr-input-group">
          <label class="fr-label" for="parcel-id">
            Identifiant de parcelle
            <span class="fr-hint-text">Saisissez l'identifiant de la parcelle √† analyser</span>
          </label>
          <input class="fr-input" type="text" id="parcel-id" name="parcel-id" placeholder="Ex: 25056000HZ0346"
            onkeypress="if(event.key==='Enter') searchParcelEnrichmentData()">
        </div>
      </div>
      <div class="fr-col-12 fr-col-md-6" style="display: flex; align-items: end;">
        <button class="fr-btn fr-btn--icon-left fr-icon-search-line" type="button"
          onclick="searchParcelEnrichmentData()">
          Rechercher la parcelle
        </button>
      </div>
    </div>
  </div>


  <!-- Loader -->
  <div id="info-loader" class="fr-callout fr-callout--blue-france fr-mt-4w" style="display: none; margin-bottom: 1rem;">
    <h3 class="fr-callout__title">
      <span class="fr-icon-refresh-fill animate-spin mr-2" aria-hidden="true"></span>
      Enrichissement en cours
    </h3>
    <p class="fr-callout__text">R√©cup√©ration des informations de la parcelle...</p>
  </div>

  <!-- Zone d'erreur s√©par√©e -->
  <div id="error-zone" class="fr-alert fr-alert--error fr-mt-4w" style="display: none; margin-bottom: 1rem;">
    <h3 class="fr-alert__title">Erreur</h3>
    <p id="error-message">Une erreur s'est produite</p>
  </div>

  <!-- Zone informations d√©duites -->
  <div id="info-col" class="fr-col-12 collapsed fr-mt-4w">

    <hr />
    <h3>Donn√©es publiques sourc√©es</h3>
    <p class="fr-text--sm">Ces informations ont √©t√© collect√©es automatiquement depuis les bases de donn√©es publiques,
      assurez-vous qu'elles soient correctes.</p>

    <!-- Onglets -->
    <div class="fr-tabs fr-mt-4w">
      <ul class="fr-tabs__list" role="tablist" aria-label="Donn√©es r√©cup√©r√©es automatiquement">
        <li role="presentation">
          <button type="button" id="tab-infos" class="fr-tabs__tab" tabindex="0" role="tab" aria-selected="true"
            aria-controls="tab-infos-panel">
            Informations du site
          </button>
        </li>
        <li role="presentation">
          <button type="button" id="tab-env" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false"
            aria-controls="tab-env-panel">
            Environnement du site
          </button>
        </li>
        <li role="presentation">
          <button type="button" id="tab-risques" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false"
            aria-controls="tab-risques-panel">
            Risques & zonage
          </button>
        </li>
      </ul>

      <!-- Panneau Infos parcelle -->
      <div id="tab-infos-panel" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel"
        aria-labelledby="tab-infos" tabindex="0">
        <div class="fr-grid-row fr-grid-row--gutters">
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Commune</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-commune">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-commune" role="tooltip">
                Donn√©e r√©cup√©r√©e depuis l'API du cadastre national (source: DGFiP)
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{commune}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Identifiant parcelle</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-surface">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-surface" role="tooltip">
                Donn√©e r√©cup√©r√©e depuis l'API du cadastre national (source: DGFiP)
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{identifiantParcelle}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Surface du site</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-surface">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-surface" role="tooltip">
                Donn√©e r√©cup√©r√©e depuis l'API du cadastre national (source: DGFiP)
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{surfaceParcelle}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Surface b√¢tie</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-batie">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-batie" role="tooltip">
                Calcul√©e automatiquement depuis les donn√©es g√©ospatiales IGN
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{surfaceBatie}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Connection au r√©seau d'√©lectricit√©</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-proprietaire">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-proprietaire" role="tooltip">
                Information extraite de l'API ENEDIS
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{connectionElectricite}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Ancienne activit√©</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-activite">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-activite" role="tooltip">
                Identifi√©e via l'analyse historique des archives municipales
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{ancienneActivite}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Panneau Environnement & alentours -->
      <div id="tab-env-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tab-env" tabindex="0">
        <div class="fr-grid-row fr-grid-row--gutters">
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Site en centre ville</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-centre">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-centre" role="tooltip">
                D√©termin√© par g√©olocalisation via l'API des zones urbaines INSEE
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{centreVille}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Distance de l'autoroute</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-autoroute">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-autoroute" role="tooltip">
                Calcul√©e via l'API de routage du service public de la donn√©e
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{distanceAutoroute}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Distance au transport en commun</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-transport">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-transport" role="tooltip">
                Donn√©es extraites de l'API transport.data.gouv.fr
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{distanceTrain}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Proximit√© des commerces et services</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-commerces">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-commerces" role="tooltip">
                Analys√© via les donn√©es OpenStreetMap et base SIRENE
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{proximiteCommerces}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Distance au raccordement √©lectrique</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-raccordement">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-raccordement" role="tooltip">
                Information fournie par l'API g√©oportail d'Enedis
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{distanceRaccordement}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Taux de logements vacants</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-vacants">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-vacants" role="tooltip">
                Statistique communale extraite des donn√©es INSEE (dernier recensement)
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{tauxLV}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Panneau Risques & Zones -->
      <div id="tab-risques-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tab-risques" tabindex="0">
        <div class="fr-grid-row fr-grid-row--gutters">
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Pr√©sence de risques technologiques</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-techno">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-techno" role="tooltip">
                Donn√©es extraites du portail georisques.gouv.fr (BRGM)
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{risquesTechno}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Pr√©sence de risques naturels</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-naturels">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-naturels" role="tooltip">
                √âvaluation bas√©e sur les donn√©es BRGM et M√©t√©o-France
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{risquesNaturels}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Type de zonage environnemental</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-zonage-env">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-zonage-env" role="tooltip">
                R√©f√©rentiel des zones prot√©g√©es du Minist√®re de la Transition √âcologique
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{zonageEnviro}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Zonage r√©glementaire</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-zonage-urb">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-zonage-urb" role="tooltip">
                Extrait du Plan Local d'Urbanisme communal via le G√©oportail de l'Urbanisme
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{zonageUrba}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Type de zonage patrimonial</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-patrimoine">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-patrimoine" role="tooltip">
                Donn√©es du service des Monuments Historiques (base M√©rim√©e)
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{zonagePatrimonial}}</span>
            </div>
          </div>
          <div class="fr-col-6">
            <div class="fr-text fr-text--lg">
              <strong>Continuit√© √©cologique (trame verte et bleue)</strong>
              <button class="fr-btn--tooltip fr-btn fr-btn--sm" type="button" aria-describedby="tooltip-trame">
                <span class="fr-icon-information-line" aria-hidden="true"></span>
              </button>
              <span class="fr-tooltip fr-placement" id="tooltip-trame" role="tooltip">
                R√©f√©rentiel √©tabli via les donn√©es du Mus√©um National d'Histoire Naturelle
              </span>
              <br>
              <span class="fr-badge fr-badge--blue-france">{{tvb}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Navigation buttons -->
  <div id="navigation-buttons" class="fr-mt-4w" style="text-align: right;">
    <a href="{{nextUrl}}" class="fr-btn" id="next-btn">
      Suivant
      <span class="fr-icon-arrow-right-s-line fr-icon--sm" aria-hidden="true"></span>
    </a>
  </div>

</div>

<script>
  // Fonction pour basculer entre les modes Carte et ID
  function switchMode(mode) {
    const carteMode = document.getElementById('carte-mode');
    const idMode = document.getElementById('id-mode');

    // Masquer tous les modes
    carteMode.classList.remove('active');
    idMode.classList.remove('active');

    // Afficher le mode s√©lectionn√©
    if (mode === 'carte') {
      carteMode.classList.add('active');
    } else if (mode === 'id') {
      idMode.classList.add('active');
    }

    // R√©initialiser l'affichage des infos si n√©cessaire
    const infoCol = document.getElementById('info-col');
    const navigationButtons = document.getElementById('navigation-buttons');
  }

  // Fonction pour g√©rer le changement de s√©lection multi-parcelle
  function handleMultiParcelleChange(event) {
    // Si l'utilisateur s√©lectionne "Plusieurs parcelles"
    if (event.target.value === "2") {
      // Afficher le message d'information
      alert("La gestion multi-parcelles n'est pas encore disponible mais le sera bient√¥t !");

      // Remettre automatiquement la s√©lection sur "Une parcelle"
      document.getElementById('multiparcelle-map-simple').checked = true;
      event.target.checked = false;
    }
  }

  // Fonction pour s√©lectionner une parcelle depuis la carte (avec identifiant pr√©d√©fini)
  function selectParcel(event) {
    if (event) event.stopPropagation();

    //TODO: Remplacer cette logique par une vraie s√©lection de parcelle sur la carte
    const testParcelId = '25056000HZ0346';
    document.getElementById('parcel-id').value = testParcelId;

    // Appeler la fonction de recherche des donn√©es enrichies avec l'ID de parcelle
    searchParcelEnrichmentData(testParcelId.trim());
  }

  // Fonction pour afficher une erreur
  function showError(message) {
    const errorZone = document.getElementById('error-zone');
    const errorMessage = document.getElementById('error-message');
    const infoCol = document.getElementById('info-col');

    // Afficher le message d'erreur
    errorMessage.textContent = message;
    errorZone.style.display = 'block';

    // Masquer les donn√©es (sans d√©truire la structure HTML)
    infoCol.classList.remove('expanded');
    infoCol.classList.add('collapsed');
  }

  // Fonction pour masquer l'erreur
  function hideError() {
    const errorZone = document.getElementById('error-zone');
    errorZone.style.display = 'none';
  }

  // Fonction pour afficher les donn√©es avec succ√®s
  function showSuccess(data) {
    const infoCol = document.getElementById('info-col');

    // Masquer l'erreur
    hideError();

    // Injecter les donn√©es et afficher
    replacePlaceholders(infoCol, data);
    infoCol.classList.remove('collapsed');
    infoCol.classList.add('expanded');
  }

  // Fonction pour r√©cup√©rer les donn√©es enrichies d'une parcelle par son identifiant
  // Appel √† l'API pour enrichir les donn√©es de la parcelle
  // Fonction pour r√©cup√©rer les donn√©es enrichies d'une parcelle par son identifiant
  async function searchParcelEnrichmentData(parcelId = null) {
    const loader = document.getElementById('info-loader');

    // Si pas d'ID fourni, r√©cup√©rer la valeur de l'input
    if (!parcelId) {
      const inputElement = document.getElementById('parcel-id');
      parcelId = inputElement?.value?.trim();
    }

    if (!parcelId) {
      showError('Veuillez saisir un identifiant de parcelle');
      return;
    }

    // Masquer les erreurs pr√©c√©dentes et afficher le loader
    hideError();
    if (loader) loader.style.display = 'block';

    try {
      const response = await fetch('/analyse/enrichir-parcelle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ identifiantParcelle: parcelId })
      });

      const result = await response.json();
      console.log('[DEBUG] API response :', result);

      if (result.success) {
        // Succ√®s : afficher les donn√©es
        showSuccess(result.data);
      } else {
        // Erreur API : afficher le message d'erreur
        showError(`Impossible de trouver les donn√©es pour cette parcelle : ${result.error}`);
      }
    } catch (error) {
      console.error('[DEBUG] Erreur fetch enrichissement :', error);
      // Erreur technique : afficher le message d'erreur
      showError('Une erreur technique s\'est produite lors de la r√©cup√©ration des donn√©es.');
    } finally {
      // Toujours masquer le loader
      if (loader) loader.style.display = 'none';
    }

    // Scroll vers la zone de r√©sultat (erreur ou succ√®s)
    setTimeout(() => {
      const targetElement = document.getElementById('error-zone').style.display !== 'none'
        ? document.getElementById('error-zone')
        : document.getElementById('info-col');

      targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }

  // Fonction pour injecter les donn√©es (simplifi√©e)
  function injectParcelDataInDom(data) {
    showSuccess(data);
  }


</script>